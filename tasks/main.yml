---

- name: Install gdnsd packages
  apt:
    name: '{{ gdnsd__packages }}'
    state: present

- name: gdnsd configuration
  template:
    src: 'etc/gdnsd/config.j2'
    dest: '/etc/gdnsd/config'
    owner: 'root'
    group: 'root'
    mode: '0644'
  notify:
    - Restart gdnsd

- name: Generate serial
  set_fact:
    gdnsd__fact_zone_serial: '{{ ansible_date_time.epoch }}'
  run_once: True

- name: Read existing forward zone hashes
  shell: 'grep "^; Hash:" /etc/gdnsd/zones/{{ item.domain }} || true'
  changed_when: False
  check_mode: no
  register: gdnsd__register_forward_hashes
  when: ('domain' in item.keys())
  # If 'gdnsd__zones' is empty add the domain detected by Ansible
  loop: '{{ gdnsd__zones
            if (gdnsd__zones | length) > 0
            else [ {"domain": ansible_domain} ] }}'
  loop_control:
    label: '{{ item.domain }}'

- name: Generate forward zones
  template:
    src: 'etc/gdnsd/zones/forward_zone.j2'
    dest: '/etc/gdnsd/zones/{{ item.domain }}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  when: ('domain' in item.keys())
  loop: '{{ gdnsd__zones
            if (gdnsd__zones | length) > 0
            else [ {"domain": ansible_domain} ] }}'
  loop_control:
    label: '{{ item.domain }}'

- name: Read reverse zone hashes
  shell: 'grep "^; Hash:" /etc/gdnsd/zones/{{ gdnsd__default_reverse_zone
                                              if (not "reverse_zone" in item)
                                              else item.reverse_zone }} || true'
  changed_when: False
  check_mode: no
  register: gdnsd__register_reverse_hashes
  when: (item.auto_reverse_zone|d(gdnsd__auto_reverse_zone) and
         item.domain|d('') | length > 0) or
        (item.reverse_zone|d('') | length > 0)
  loop: '{{ gdnsd__zones
            if (gdnsd__zones | length) > 0
            else [ {"reverse_zone": gdnsd__default_reverse_zone} ] }}'
  loop_control:
    label: '{{ item.reverse_zone|d(gdnsd__default_reverse_zone) }}'

- name: Generate reverse zones
  template:
    src: 'etc/gdnsd/zones/reverse_zone.j2'
    dest: '/etc/gdnsd/zones/{{ gdnsd__default_reverse_zone
                               if (not "reverse_zone" in item)
                               else item.reverse_zone }}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  when: (item.auto_reverse_zone|d(gdnsd__auto_reverse_zone) and
         item.domain|d('') | length > 0) or
        (item.reverse_zone|d('') | length > 0)
  loop: '{{ gdnsd__zones
            if (gdnsd__zones | length) > 0
            else [ {"reverse_zone": gdnsd__default_reverse_zone} ] }}'
  loop_control:
    label: '{{ item.reverse_zone|d(gdnsd__default_reverse_zone) }}'

- name: Check configuration and zone files
  command: gdnsd -s checkconf  # noqa 301
  check_mode: no
  changed_when: False
  failed_when: False
  register: gdnsd__register_checkconf

- name: Show checkconf output
  debug:
    msg: '{{ gdnsd__register_checkconf.stdout_lines +
             gdnsd__register_checkconf.stderr_lines }}'
  failed_when:
    - gdnsd__register_checkconf.rc != 0
    - not ansible_check_mode

- name: Enable and start service
  service:
    name: 'gdnsd'
    enabled: True
    state: started
